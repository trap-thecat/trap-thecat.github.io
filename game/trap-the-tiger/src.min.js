init(3);
function eventStart(){setGameSpeed(60,c.style.position="absolute",fade=0,backgroundColor="black");fitCanvas(canvasWidth=320,canvasHeight=480);escaping=!1;stats={highscore:0,taps:0,trapped:0,escaped:0,games:0,highlevel:0,time:0};"undefined"!==typeof localStorage.highscore&&(stats.highscore=parseInt(localStorage.highscore));"undefined"!==typeof localStorage.taps&&(stats.taps=parseInt(localStorage.taps));"undefined"!==typeof localStorage.trapped&&(stats.trapped=parseInt(localStorage.trapped));"undefined"!==
typeof localStorage.escaped&&(stats.escaped=parseInt(localStorage.escaped));"undefined"!==typeof localStorage.games&&(stats.games=parseInt(localStorage.games));"undefined"!==typeof localStorage.highlevel&&(stats.highlevel=parseInt(localStorage.highlevel));"undefined"!==typeof localStorage.time&&(stats.time=parseInt(localStorage.time));LYR_MESSAGE=0;LYR_TIGER=1;LYR_TILE=2;backgroundAdd("lsmsg","assets/graphics/lsmsg.png");backgroundSet("lsmsg",canvasHeight,canvasWidth,TILENONE);backgroundAdd("menu",
"assets/graphics/menu.png");backgroundSet("menu",canvasWidth,canvasHeight,TILENONE);backgroundAdd("menualt","assets/graphics/menualt.png");backgroundSet("menualt",canvasWidth,canvasHeight,TILENONE);backgroundAdd("help","assets/graphics/help.png");backgroundSet("help",canvasWidth,canvasHeight,TILENONE);backgroundAdd("stats","assets/graphics/stats.png");backgroundSet("stats",canvasWidth,canvasHeight,TILENONE);backgroundAdd("game","assets/graphics/game.png");backgroundSet("game",canvasWidth,canvasHeight,
TILENONE);spriteAddStrip("tileblue","assets/graphics/tileblue.png",2);spriteAddStrip("tilered","assets/graphics/tilered.png",2);spriteAddStrip("tileblack","assets/graphics/tileblack.png",2);spriteAddStrip("tilegreen","assets/graphics/tilegreen.png",2);spriteAdd("tiger","assets/graphics/tiger.png");spriteAddStrip("tigerbottom","assets/graphics/tigerbottom.png",7);spriteAddStrip("tigerside","assets/graphics/tigerside.png",7);spriteAddStrip("tigertop","assets/graphics/tigertop.png",7);spriteAddStrip("tigerbottomr",
"assets/graphics/tigerbottomr.png",7);spriteAddStrip("tigersider","assets/graphics/tigersider.png",7);spriteAddStrip("tigertopr","assets/graphics/tigertopr.png",7);spriteAdd("success","assets/graphics/success.png");spriteAdd("escaped","assets/graphics/escaped.png");objectAdd("tile","tileblue",0,0,LYR_TILE);objectAdd("tiger","tiger",3,42,LYR_TIGER);objectAdd("success","success",100,80,LYR_MESSAGE);objectAdd("escaped","escaped",125,120,LYR_MESSAGE);room="preloader";loadPercent=0;load=sprites.length+
loops.length+sounds.length+backgrounds.length}
function eventStep(){if(!getLandscape())if(stats.time+=0>=fps?0:1/(60*fps),"game"==room&&90<=nextLevel&&(instancesClear(),level++,startLevel()),"menu"==room)mouseStatus==PRESSED&&(pointInRect(82,94,238,138,mouseX,mouseY)?(fade=level=1,score=0,room="game",stats.games++,localStorage.games=stats.games,localStorage.time=stats.time,startLevel()):pointInRect(82,154,238,198,mouseX,mouseY)?(fade=1,room="help",localStorage.time=stats.time):pointInRect(82,214,238,258,mouseX,mouseY)?(fade=1,room="stats",localStorage.time=
stats.time):pointInRect(82,274,238,318,mouseX,mouseY)&&(localStorage.time=stats.time,window.location.href="http://m.onemorelevel.com/"));else if(("help"==room||"stats"==room)&&mouseStatus==PRESSED&&pointInRect(82,359,238,403,mouseX,mouseY))fade=1,room="menu",localStorage.time=stats.time;else if("game"==room&&mouseStatus==PRESSED&&(pointInRect(82,421,238,465,mouseX,mouseY)&&(instancesClear(fade=1,room="stats"),localStorage.taps=stats.taps,localStorage.time=stats.time),0<instanceCount("escaped")&&0.75<
instances[instanceFind("escaped",1)].alpha))pointInRect(91,182,231,220,mouseX,mouseY)?(instancesClear(level=1,score=0),stats.games++,localStorage.games=stats.games,startLevel()):pointInRect(91,234,231,272,mouseX,mouseY)&&(window.location.href="http://m.onemorelevel.com/")}
function eventDraw(){"preloader"==room&&preload("white","menu",0.02);if(getLandscape())fadeOut(0.02,backgroundImage="lsmsg");else{if("menu"==room)backgroundColor="white",0<stats.highscore?(backgroundImage="menualt",cxt.fillStyle="black",cxt.font="12px junglefever",cxt.textAlign="center",cxt.textBaseline="middle",cxt.fillText("Highscore: "+stats.highscore,203,363)):backgroundImage="menu";else if("help"==room)backgroundImage="help";else if("stats"==room){backgroundImage="stats";cxt.fillStyle="black";
cxt.font="14px myriadprobold";cxt.textAlign="center";cxt.textBaseline="middle";var b=c.width/2;cxt.fillText("Tiles tapped: "+stats.taps,b,126);cxt.fillText("Tigers trapped: "+stats.trapped,b,152);cxt.fillText("Tigers escaped: "+stats.escaped,b,178);cxt.fillText("Games played: "+stats.games,b,204);cxt.fillText("Highest level: "+stats.highlevel,b,230);cxt.fillText("Highscore: "+stats.highscore,b,256);cxt.fillText("Total time played: "+Math.floor(stats.time)+(1==Math.floor(stats.time)?" min.":" mins."),
b,282)}else"game"==room&&(backgroundImage="game",cxt.fillStyle="black",cxt.font="14px junglefever",cxt.textAlign="left",cxt.textBaseline="alphabetic",cxt.fillText("Level: "+level,8,386),cxt.textAlign="center",cxt.fillText("Highscore: "+stats.highscore,c.width/2,408),cxt.textAlign="right",cxt.fillText("Score: "+score,c.width-8,386));("game"==room||"menu"==room||"help"==room||"stats"==room)&&fadeOut(0.02)}}function objectEventCreate(){}
function objectEventStep(b){if(!getLandscape())if(b=instances[b],60<=nextLevel){if("tile"==b.name||"tiger"==b.name||"success"==b.name)b.alpha=0.04<b.alpha?b.alpha-0.04:0;"success"==b.name&&nextLevel++}else if("success"==b.name)b.alpha=0.8>b.alpha?b.alpha+0.04:0.8,0.8<=b.alpha&&nextLevel++;else if("escaped"==b.name)b.alpha=0.8>b.alpha?b.alpha+0.04:0.8;else if("tile"==b.name)b.alpha=1>b.alpha?b.alpha+0.04:1,mouseStatus==PRESSED&&(canClick&&0==b.imageFrame&&!(b.x==grid[tiger.x][tiger.y].x&&b.y==grid[tiger.x][tiger.y].y)&&
pointInRect(b.x,b.y,b.x+37,b.y+33,mouseX,mouseY))&&(b.imageFrame=1,stats.taps++,findShortestRoute(),moveTiger());else if("tiger"==b.name){b.alpha=1>b.alpha?b.alpha+0.04:1;if(6<b.imageFrame)if(escaping){switch(b.sprite){case "tigertop":b.y-=33;b.x-=42;break;case "tigertopr":b.y-=33;b.x+=42;break;case "tigerside":b.x-=42;break;case "tigersider":b.x+=42;break;case "tigerbottom":b.y+=33;b.x-=42;break;case "tigerbottomr":b.y+=33,b.x+=42}b.imageFrame=0}else{if("tigerbottom"==b.sprite||"tigerbottomr"==b.sprite)b.sprite=
"tiger",b.imageFrame=0;b.imageSpeed=0}b.xoffset="tigerbottomr"==b.sprite||"tigertopr"==b.sprite?15:"tigersider"==b.sprite?45:3;if(!escaping){var d=grid[tiger.x][tiger.y];b.x=d.x;b.y=d.y}}}function objectEventDraw(){getLandscape()}function particleEventDraw(){getLandscape()}
function startLevel(){canClick=escaping=!1;level>stats.highlevel&&(localStorage.highlevel=stats.highlevel=level);var b=21-level;tiger={x:3,y:5};instances[instanceAdd(0,0,"tiger")].alpha=nextLevel=0;objects[objectGet("tile")].sprite=choose("tilered","tileblue","tileblack","tilegreen");grid=[[],[],[],[],[],[],[]];for(var d=0;7>d;d++)for(var e=0;11>e;e++){var f=grid[d][e]=instances[instanceAdd(6+18*(e%2)+42*d,6+33*e,"tile")];f.alpha=f.imageSpeed=0}for(d=grid[tiger.x][tiger.y];0<b;)e=irandom(6),f=irandom(10),
e=grid[e][f],0==e.imageFrame&&!(e.x==d.x&&e.y==d.y)&&(e.imageFrame=1,b--);findShortestRoute(canClick=!0)}
function findShortestRoute(){shortest=[[],[],[],[],[],[],[]];for(var b=0;7>b;b++)for(var d=0;11>d;d++)if(shortest[b][d]=77,0==grid[b][d].imageFrame){if(0==b||0==d||6==b||10==d)shortest[b][d]=1}else shortest[b][d]=-1;var e;do{e=shortest.toString();for(b=1;6>b;b++)for(d=1;10>d;d++)if(0==grid[b][d].imageFrame||tiger.x==b&&tiger.y==d){var f=lowestNeighbour(b,d,!1);f&&77>f[0]&&(shortest[b][d]=f[0]+1)}}while(e!=shortest.toString())}
function lowestNeighbour(b,d,e){for(var f=[],g=0;6>g;g++){var h=parseInt(d-1+g/2),i=parseInt(b+d%2*((g/2+1)%2)-(g+1)%2);3==g&&i++;if(0<=i&&7>i&&0<=h&&11>h)-1<shortest[i][h]&&f.push([shortest[i][h],i,h,g]);else if(e)return[0,g]}f.sort(function(b,d){return b[0]-d[0]});return f[0]}
function moveTiger(){canClick=!1;if(trapped()){score+=50;for(var b=0;7>b;b++)for(var d=0;11>d;d++)0==grid[b][d].imageFrame&&(score+=5);score>stats.highscore&&(localStorage.highscore=stats.highscore=score);instances[instanceAdd(c.width/2,c.height/2,"success")].alpha=0;stats.trapped++;localStorage.taps=stats.taps;localStorage.trapped=stats.trapped;localStorage.time=stats.time}else if(b=lowestNeighbour(tiger.x,tiger.y,!0),0<b[0]){grid[tiger.x][tiger.y].imageFrame=0;tiger.x=b[1];tiger.y=b[2];d=instances[instanceFind("tiger",
1)];switch(b[3]){case 0:d.sprite="tigertop";break;case 1:d.sprite="tigertopr";break;case 2:d.sprite="tigerside";break;case 3:d.sprite="tigersider";break;case 4:d.sprite="tigerbottom";break;case 5:d.sprite="tigerbottomr"}d.imageFrame=0;d.imageSpeed=0.5;canClick=!0}else{escaping=!0;d=instances[instanceFind("tiger",1)];switch(b[1]){case 0:d.sprite="tigertop";d.y-=33;d.x-=42;break;case 1:d.sprite="tigertopr";d.y-=33;d.x+=42;break;case 2:d.sprite="tigerside";d.x-=42;break;case 3:d.sprite="tigersider";
d.x+=42;break;case 4:d.sprite="tigerbottom";d.y+=33;d.x-=42;break;case 5:d.sprite="tigerbottomr",d.y+=33,d.x+=42}d.imageFrame=0;d.imageSpeed=0.5;instances[instanceAdd(c.width/2,c.height/2,"escaped")].alpha=0;stats.escaped++;localStorage.taps=stats.taps;localStorage.escaped=stats.escaped;localStorage.time=stats.time}}
function trapped(){for(var b=0;6>b;b++){var d=parseInt(tiger.y-1+b/2),e=parseInt(tiger.x+tiger.y%2*((b/2+1)%2)-(b+1)%2);3==b&&e++;if(0<=e&&7>e&&0<=d&&11>d){if(0==grid[e][d].imageFrame)return!1}else return!1}return!0}
function init(b){canvasId="gameCanvas";soundId="soundSpan";var d=navigator.userAgent.toLowerCase();device=/ip(hone|od)/i.test(d)?1:/android/i.test(d)?2:/blackberry/i.test(d)?3:/ipad/i.test(d)?4:!/mob/i.test(d)?0:5;landscape=!1;window.onload=function(){0<device&&hideAddressBar(!0,b)};window.onresize=function(){fitCanvas(canvasWidth,canvasHeight);landscape="preloader"!=room&&window.innerWidth>window.innerHeight&&0<device;0<device&&hideAddressBar(!1)};window.onorientationchange=function(){fitCanvas(canvasWidth,
canvasHeight);landscape="preloader"!=room&&window.innerWidth>window.innerHeight&&0<device;hideAddressBar(!1,fade=1)};window.ontouchmove=function(b){b.preventDefault()}}function setScale(b,d){xscale=parseInt(c.style.width)/b;yscale=parseInt(c.style.height)/d;c.width=b;c.height=d}function getResizeRatio(b,d,e,f){b=e/b;d=f/d;return b<=d?b:d}function getResizeDimensions(b,d,e,f){e=getResizeRatio(b,d,e,f);return{width:Math.round(b*e),height:Math.round(d*e)}}
function fitCanvas(b,d){var e=window.innerWidth,f=window.innerHeight,g=getResizeDimensions(0<device&&e>f?d:b,0<device&&e>f?b:d,e,1==device&&e<f?e*(d/b):f);c.style.width=g.width+"px";c.style.height=g.height+"px";setScale(0<device&&e>f?d:b,0<device&&e>f?b:d);c.style.top=1==device&&e<f?"0":(f-g.height)/2+"px";c.style.left=(e-g.width)/2+"px"}function getLandscape(){return landscape}function fadeOut(b){0<fade&&(cxt.fillStyle="rgba(0, 0, 0, "+fade+")",cxt.fillRect(0,0,c.width,c.height,fade-=b))}
function mobileDebug(b){cxt.fillStyle=b;cxt.textAlign="left";cxt.textBaseline="alphabetic";cxt.font="bold 12px sans-serif";cxt.fillText("FPS: "+fps+" / "+Math.round(1E3/gamespeed),12,20);cxt.fillText("Mouse: ("+Math.round(mouseX)+", "+Math.round(mouseY)+")  Status: "+mouseStatus,12,36);cxt.fillText("Device: "+(0==device?"Desktop":1==device||4==device?"iOS":2==device?"Android":3==device?"Blackberry":"Mobile"),12,52)}
function preload(b,d,e){for(var f=0,g=0,h=sprites.length;g<h;g++)spriteLoaded(sprites[g].name)&&f++;g=0;for(h=backgrounds.length;g<h;g++)backgroundLoaded(backgrounds[g].name)&&f++;g=0;for(h=sounds.length;g<h;g++)soundLoaded(sounds[g].name)&&f++;g=0;for(h=loops.length;g<h;g++)loopLoaded(loops[g].name)&&f++;loadPercent<f/load&&(loadPercent+=e);cxt.fillStyle=b;fillRect(0,c.height/2-16,c.width*loadPercent,c.height/2+16);cxt.textAlign="center";cxt.font="bold 30px sans-serif";cxt.textBaseline="alphabetic";
cxt.fillText("LOADING...",c.width/2,c.height/2-16);1<=loadPercent&&instancesClear(fade=1,room=d)}function hideAddressBar(b,d){document.documentElement.scrollHeight<window.outerHeight/window.devicePixelRatio&&(document.documentElement.style.height=window.outerHeight/window.devicePixelRatio+"px");setTimeout(window.scrollTo(0,2==device?1:0),0);b&&setTimeout("hideAddressBar(true, "+d+")",1E3*d)};window.addEventListener("load",engineStart);document.addEventListener("mousemove",getMouseCoordinates,!1);document.addEventListener("keydown",keyPress);document.addEventListener("keypress",keyPress);document.addEventListener("keyup",keyRelease);CLVERSION=1.02;RELEASED=-1;DORMANT=0;HELD=1;PRESSED=2;KEY_LEFT=37;KEY_UP=38;KEY_RIGHT=39;KEY_DOWN=40;KEY_SPACE=32;NOONE=-1;NONE="none";TILENONE=0;TILEX=1;TILEY=2;TILEBOTH=3;function irandom(b){return Math.round(b*Math.random())}
function irandomRange(b,d){return b+Math.round((d-b)*Math.random())}function sign(b){return 0==b?0:0>b?-1:1}function pointDistance(b,d,e,f){return Math.round(Math.sqrt(Math.pow(e-b,2)+Math.pow(f-d,2)))}function pointDirection(b,d,e,f,g){void 0==g&&(g=0);var h=Math.round(360-180*(Math.atan((f-d)/(e-b))/Math.PI));e<b&&(h-=180);for(0>h&&(h+=359);360<=h;)h-=360;return b==e&&d==f?g:h}function angleDifference(b,d){return((b-d)%360+540)%360-180}function lengthDirX(b,d){return b*Math.cos(d*Math.PI/180)}
function lengthDirY(b,d){return-b*Math.sin(d*Math.PI/180)}function choose(){return arguments[irandom(arguments.length-1)]}function colorRandom(b,d){return"rgb("+irandomRange(b,d)+","+irandomRange(b,d)+","+irandomRange(b,d)+")"}function colorMakeRGB(b,d,e){return"rgb("+b+","+d+","+e+")"}function colorMakeHSL(b,d,e){return"hsl("+b+","+Math.round(d)+"%,"+Math.round(e)+"%)"}
function colorMakeHSV(b,d,e){var f=d/255,d=e/255;if(0==f)f=d=e;else{var g=6*(b/255);6==g&&(g=0);var e=Math.floor(g),b=d*(1-f),h=d*(1-f*(g-e)),f=d*(1-f*(1-(g-e)));0==e?(var_r=d,var_g=f,var_b=b):1==e?(var_r=h,var_g=d,var_b=b):2==e?(var_r=b,var_g=d,var_b=f):3==e?(var_r=b,var_g=h,var_b=d):4==e?(var_r=f,var_g=b,var_b=d):(var_r=d,var_g=b,var_b=h);d=Math.round(255*var_r);f=Math.round(255*var_g);e=Math.round(255*var_b)}return"rgb("+d+","+f+","+e+")"}
function randomColor(b,d){return"#"+(b+irandom(d-b))+(b+irandom(d-b))+(b+irandom(d-b))}function clearCanvas(){cxt.clearRect(0,0,c.width,c.height)}function alarmSet(b,d){setTimeout(b,d*gamespeed)}function setFPS(){!0==debugPlaying&&(fps=sts);sts=0}function setGamespeed(b){gamespeed=b;clearInterval(stepInterval);stepInterval=setInterval("engineStep()",gamespeed)}function setGameSpeed(b){gamespeed=1E3/b;clearInterval(stepInterval);stepInterval=setInterval("engineStep()",gamespeed)}
function sortDepth(b,d){return d.depth-b.depth}function getMouseCoordinates(b){void 0!=b.pageX&&void 0!=b.pageY?(trueMouseX=b.pageX,trueMouseY=b.pageY):(trueMouseX=b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,trueMouseY=b.clientY+document.body.scrollTop+document.documentElement.scrollTop);trueMouseX-=c.offsetLeft;trueMouseY-=c.offsetTop;if(0>trueMouseX||trueMouseX>parseInt(c.style.width)||0>trueMouseY||trueMouseY>parseInt(c.style.height))mouseStatus=-1}
function mouseClick(){mouseStatus=2}function mouseRelease(){mouseStatus=-1}function mouseUpdate(){mouseX=(trueMouseX+cameraX)/xscale;mouseY=(trueMouseY+cameraY)/yscale;2==mouseStatus&&(mouseStatus=1);-1==mouseStatus&&(mouseStatus=0)}function keyAdd(b,d){var e=keys.length;keys[e]={};keys[e].keycode=d;keys[e].status=0;keys[e].name=b}
function keyPress(b){for(var b=window.event?event:b,b=b.charCode?b.charCode:b.keyCode,d=0;d<keys.length;)b==keys[d].keycode&&0>=keys[d].status&&(keys[d].status=2),d++;keyLastPressed=b;!0==debug&&192==b&&debugToggle()}function keyRelease(b){for(var b=window.event?event:b,b=b.charCode?b.charCode:b.keyCode,d=0;d<keys.length;)b==keys[d].keycode&&1<=keys[d].status&&(keys[d].status=-1),d++;keyLastReleased=b}
function keyUpdate(){for(var b=0;b<keys.length;)-1==keys[b].status?keys[b].status=0:2==keys[b].status&&(keys[b].status=1),b++}function keyStatus(b){for(var d=0;d<keys.length;){if(keys[d].name==b)return keys[d].status;d++}}function keyValue(b){for(var d=0;d<keys.length;){if(keys[d].name==b)return keys[d].status;d++}}function keyCheck(b){for(var d=0;d<keys.length;){if(keys[d].name==b)return 0>=keys[d].status?0:1;d++}}
function keyChange(b,d){for(var e=0;e<keys.length;)keys[e].name==b&&(keys[e].status=0,keys[e].keycode=d),e++}function touchStart(b){touches=b.touches;touchUpdate(2)}function touchMove(b){touches=b.touches;touchUpdate(1)}function touchEnd(b){touches=b.touches;touchUpdate(-1)}
function touchUpdate(b){-1!=b&&(trueMouseX=touches[0].pageX+document.body.scrollLeft+document.documentElement.scrollLeft-c.offsetLeft,trueMouseY=touches[0].pageY+document.body.scrollTop+document.documentElement.scrollTop-c.offsetTop);mouseStatus=b}function spriteAdd(b,d){var e=sprites.length;sprites[e]=new Image;sprites[e].name=b;sprites[e].src=d;sprites[e].frames=1}function spriteAddStrip(b,d,e){var f=sprites.length;sprites[f]=new Image;sprites[f].name=b;sprites[f].src=d;sprites[f].frames=e}
function spriteLoaded(b){return spriteGet(b).complete}function spriteGet(b){for(var d=0;d<sprites.length;){if(sprites[d].name==b)return sprites[d];d++}}function spriteSetColorRGB(b,d,e,f){for(w=0;w<sprites.length;w++)if(sprites[w].name==b){alert(w);var g=sprites[w].data}for(var h=0,i=g.length;h<i;h+=4)g[h]=d,g[h+1]=e,g[h+2]=f;alert(g);for(w=0;w<sprites.length;w++)sprites[w].name==b&&(sprites[w].data=g)}
function spriteSetColorHSV(b,d,e,f){d/=255;e/=255;f/=255;if(0==e)e=Math.round(255*f),d=Math.round(255*f),f=Math.round(255*f);else{var g=6*d;6==g&&(g=0);var d=Math.floor(g),h=f*(1-e),i=f*(1-e*(g-d)),e=f*(1-e*(1-(g-d)));0==d?(var_r=f,var_g=e,var_b=h):1==d?(var_r=i,var_g=f,var_b=h):2==d?(var_r=h,var_g=f,var_b=e):3==d?(var_r=h,var_g=i,var_b=f):4==d?(var_r=e,var_g=h,var_b=f):(var_r=f,var_g=h,var_b=i);e=Math.round(255*var_r);d=Math.round(255*var_g);f=Math.round(255*var_b)}for(w=0;w<sprites.length;w++)if(sprites[w].name==
b)var j=sprites[w].data;h=0;for(i=j.length;h<i;h+=4)j[h]=e,j[h+1]=d,j[h+2]=f;for(w=0;w<sprites.length;w++)sprites[w].name==b&&(sprites[w]=j)}function spriteDraw(b,d,e){b=spriteGet(b);cxt.drawImage(b,0,0,b.width/b.frames,b.height,d-cameraX,e-cameraY,b.width,b.height)}
function spriteDrawExt(b,d,e,f,g,h,i,j,l,m){var b=spriteGet(b),n=cxt.globalAlpha;cxt.globalAlpha=m;cxt.save();cxt.translate(d-cameraX+b.width/b.frames*i/2,e-cameraY+b.height*j/2);cxt.rotate(-(l/(180/Math.PI)));cxt.translate(-(d-cameraX+b.width/b.frames*i/2),-(e-cameraY+b.height*j/2));cxt.drawImage(b,f*(b.width/b.frames),0,b.width/b.frames,b.height,d-g-cameraX,e-h-cameraY,b.width/b.frames*i,b.height*j);cxt.restore();cxt.globalAlpha=n}
function spriteDrawAngle(b,d,e,f){cxt.save();b=spriteGet(b);cxt.translate(d-cameraX+b.width/b.frames/2,e-cameraY+b.height/2);cxt.rotate(-(f/(180/Math.PI)));cxt.translate(-(d-cameraX+b.width/b.frames/2),-(e-cameraY+b.height/2));cxt.drawImage(b,0,0,b.width/b.frames,b.height,d-cameraX,e-cameraY,b.width/b.frames,b.height);cxt.restore()}
function spriteDrawAngleScaled(b,d,e,f,g,h){cxt.save();b=spriteGet(b);cxt.translate(d-cameraX+b.width/b.frames*f/2,e-cameraY+b.height*g/2);cxt.rotate(-(h/(180/Math.PI)));cxt.translate(-(d-cameraX+b.width/b.frames*f/2),-(e-cameraY+b.height*g/2));cxt.drawImage(b,0,0,b.width/b.frames,b.height,d-cameraX,e-cameraY,b.width/b.frames*f,b.height*g);cxt.restore()}
function spriteDrawAngleAtPoint(b,d,e,f,g,h){cxt.save();b=spriteGet(b);cxt.translate(d-f,e-g);cxt.rotate(-((h-90)/(180/Math.PI)));cxt.translate(-(d-(b.width-f)),-(e-(b.height-g)));cxt.drawImage(b,d-f,e-g);cxt.restore()}
function objectAdd(b,d,e,f,g){var h=objects.length;objects[h]={};objects[h].name=b;objects[h].sprite=d;objects[h].alpha=1;objects[h].xoffset=e;objects[h].yoffset=f;objects[h].xscale=1;objects[h].yscale=1;objects[h].friction=0;objects[h].width=0;objects[h].height=0;objects[h].depth=g;objects[h].mask=0;objects[h].maskX=0;objects[h].maskY=0;objects[h].imageSpeed=1}
function objectAddExt(b,d,e,f,g,h,i,j,l,m,n,o){var k=objects.length;objects[k]={};objects[k].name=b;objects[k].sprite=d;objects[k].alpha=g;objects[k].xoffset=h;objects[k].yoffset=i;objects[k].xscale=j;objects[k].yscale=l;objects[k].friction=m;objects[k].width=e;objects[k].height=f;objects[k].mask=n;objects[k].maskX=0;objects[k].maskY=0;objects[k].depth=o;objects[k].imageSpeed=1}function objectGet(b){for(var d=0;d<objects.length;){if(objects[d].name==b)return d;d++}}
function instanceAdd(b,d,e){var f=instances.length,g=objectGet(e);instances[f]={};instances[f].id=f;instances[f].active=!0;instances[f].name=e;instances[f].x=b;instances[f].y=d;instances[f].maskX=0;instances[f].maskY=0;instances[f].hspeed=0;instances[f].vspeed=0;instances[f].xoffset=objects[g].xoffset;instances[f].yoffset=objects[g].yoffset;instances[f].xscale=objects[g].xscale;instances[f].yscale=objects[g].yscale;instances[f].friction=objects[g].friction;instances[f].alpha=objects[g].alpha;instances[f].sprite=
objects[g].sprite;instances[f].width=objects[g].width;instances[f].height=objects[g].height;instances[f].depth=objects[g].depth;instances[f].imageFrame=0;instances[f].imageSpeed=objects[g].imageSpeed;instances[f].imageAngle=0;objectEventCreate(f);return f}function instanceExists(b){for(var d=0;d<instances.length;){if(instances[d].name==b)return!0;d++}return!1}function instanceCount(b){for(var d=0,e=0;d<instances.length;)instances[d].name==b&&e++,d++;return e}
function instanceFind(b,d){for(var e=0,f=0;e<instances.length;){if(instances[e].name==b&&(f++,f==d))return e;e++}return-1}function instanceDestroy(b){instances.splice(b,1);for(x=0;x<instances.length;x++)instances[x].id=x}function instancesClear(){instances.splice(0,instances.length)}function backgroundAdd(b,d){var e=backgrounds.length;backgrounds[e]=new Image;backgrounds[e].name=b;backgrounds[e].src=d;backgrounds[e].tile=0}
function backgroundGet(b){for(var d=0;d<backgrounds.length;){if(backgrounds[d].name==b)return d;d++}}function backgroundSet(b,d,e,f){b=backgroundGet(b);-1!=d&&(backgrounds[b].width=d);-1!=e&&(backgrounds[b].height=e);backgrounds[b].tile=f}function backgroundLoaded(b){b=backgroundGet(b);return backgrounds[b].complete}
function particleTypeAdd(b,d,e,f,g,h,i){var j=particleTypes.length;particleTypes[j]={};particleTypes[j].name=b;particleTypes[j].xvariance=d;particleTypes[j].yvariance=e;particleTypes[j].minsize=f;particleTypes[j].maxsize=g;particleTypes[j].minlife=h;particleTypes[j].maxlife=i}function particleTypeGet(b){for(var d=0;d<particleTypes.length;){if(particleTypes[d].name==b)return d;d++}}
function particleAdd(b,d,e,f,g,h){var i=particles.length,j=particleTypeGet(b);particles[i]={};particles[i].type=b;particles[i].x=d+irandom(-particleTypes[j].xvariance)+irandom(particleTypes[j].xvariance);particles[i].y=e+irandom(-particleTypes[j].yvariance)+irandom(particleTypes[j].yvariance);particles[i].hspeed=f;particles[i].vspeed=g;particles[i].color=h;particles[i].size=irandom(particleTypes[j].maxsize-particleTypes[j].minsize)+particleTypes[j].minsize;particles[i].life=irandom(particleTypes[j].maxlife-
particleTypes[j].minlife)+particleTypes[j].minlife}function particleDestroy(b){particles.splice(b,1)}function particlesClear(){particles.splice(0,particles.length)}function motionSet(b,d,e){instances[b].hspeed=lengthDirX(d,e);instances[b].vspeed=lengthDirY(d,e)}function motionAdd(b,d,e){var f=lengthDirX(d,e)+instances[b].hspeed,e=lengthDirY(d,e)+instances[b].vspeed,d=pointDistance(0,0,f,e),f=pointDirection(0,0,f,e);instances[b].hspeed=lengthDirX(d,f);instances[b].vspeed=lengthDirY(d,f)}
function motionAddXY(b,d,e){instances[b].hspeed+=d;instances[b].vspeed+=e}function motionGetDir(b){return pointDirection(0,0,instances[b].hspeed,instances[b].vspeed)}function motionGetDis(b){return pointDistance(0,0,instances[b].hspeed,instances[b].vspeed)}function hitboxSetMask(b,d){instances[b].mask=d}function hitboxSet(b,d,e,f,g,h){instances[b].width=d;instances[b].height=e;instances[b].maskX=f;instances[b].maskY=g;instances[b].mask=h}
function hitboxCollide(b,d){for(var e=0;e<instances.length;){if(!0==instances[e].active&&instances[e].mask==d&&e!=b&&instances[b].width/2+instances[e].width/2>Math.abs(instances[b].x-instances[b].xoffset+instances[b].maskX-(instances[e].x-instances[e].xoffset+instances[e].maskX))&&instances[b].height/2+instances[e].height/2>Math.abs(instances[b].y-instances[b].yoffset+instances[b].maskY-(instances[e].y-instances[e].yoffset+instances[e].maskY)))return e;e++}return-1}
function hitboxCollidePosition(b,d,e,f){for(var g=0;g<instances.length;){if(!0==instances[g].active&&instances[g].mask==d&&g!=b&&instances[b].width/2+instances[g].width/2>Math.abs(e-instances[b].xoffset+instances[b].maskX-(instances[g].x-instances[g].xoffset+instances[g].maskX))&&instances[b].height/2+instances[g].height/2>Math.abs(f-instances[b].yoffset+instances[b].maskY-(instances[g].y-instances[g].yoffset+instances[g].maskY)))return g;g++}return-1}
function collidePosition(b,d,e,f){for(var g=0;g<instances.length;){if(!0==instances[g].active&&instances[g].mask==d&&g!=b&&instances[g].width>Math.abs(e-(instances[g].x-instances[g].xoffset+instances[g].maskX))&&instances[g].height>Math.abs(f-(instances[g].y-instances[g].yoffset+instances[g].maskY)))return g;g++}return-1}function pointInRect(b,d,e,f,g,h){return g>=Math.min(b,e)&&g<=Math.max(b,e)&&h>=Math.min(d,f)&&h<=Math.max(d,f)?!0:!1}function colorSet(b){cxt.fillStyle=b;cxt.strokeStyle=b}
function fontReset(){cxt.textAlign="start";cxt.textBaseline="alphabetic";cxt.font="10px sans-serif"}function textDraw(b,d,e){cxt.fillText(e,b-cameraX,d-cameraY)}function textDrawAngle(b,d,e,f){cxt.save();var g=cxt.measureText(e);"center"==cxt.textAlign?g.width=0:"right"==cxt.textAlign&&(g.width*=-1);cxt.translate(b-cameraX+g.width/2,d-cameraY);cxt.rotate(-(f/(180/Math.PI)));cxt.translate(-(b-cameraX+g.width/2),-(d-cameraY));cxt.fillText(e,b-cameraX,d-cameraY);cxt.restore()}
function strokeLine(b,d,e,f){cxt.beginPath();cxt.moveTo(b-cameraX,d-cameraY);cxt.lineTo(e-cameraX,f-cameraY);cxt.closePath();cxt.stroke()}function fillRect(b,d,e,f){cxt.fillRect(Math.min(b,e)-cameraX,Math.min(d,f)-cameraY,Math.abs(e-b),Math.abs(f-d))}function strokeRect(b,d,e,f){cxt.strokeRect(Math.min(b,e)-cameraX,Math.min(d,f)-cameraY,Math.abs(e-b),Math.abs(f-d))}function fillCircle(b,d,e){cxt.beginPath();cxt.arc(b-cameraX,d-cameraY,e,0,2*Math.PI,!0);cxt.closePath();cxt.fill()}
function strokeCircle(b,d,e){cxt.beginPath();cxt.arc(b-cameraX,d-cameraY,e,0,2*Math.PI,!0);cxt.closePath();cxt.stroke()}function drawPolygon(b,d,e,f,g,h){cxt.beginPath();cxt.moveTo(b+lengthDirX(f,e)-cameraX,d+lengthDirY(f,e)-cameraY);for(s=1;s<g;s++)cxt.lineTo(b+lengthDirX(f,e+s*(360/g))-cameraX,d+lengthDirY(f,e+s*(360/g))-cameraY);cxt.closePath();!0==h&&cxt.fill();!1==h&&cxt.stroke()}
function soundAdd(b,d,e){var f=sounds.length;void 0==e&&(e=8);sounds[f]={};sounds[f].channels=e;sounds[f].channel=1;sounds[f].name=b;sounds[f].ae=[];for(a=1;a<=e;a++)sounds[f].ae[a]=new Audio(d),sounds[f].ae[a].preload=!0}function soundGet(b){for(var d=0;d<sounds.length;){if(sounds[d].name==b)return d;d++}}function soundPlay(b){b=soundGet(b);sounds[b].ae[sounds[b].channel].play();sounds[b].channel++;sounds[b].channel>sounds[b].channels&&(sounds[b].channel=1)}
function soundLoaded(b){return 4==sounds[soundGet(b)].ae[1].readyState?!0:!1}function loopAdd(b,d){var e=loops.length;loops[e]=new Audio(d);loops[e].name=b;loops[e].addEventListener("ended",function(){this.currentTime=0})}function loopGet(b){for(var d=0;d<loops.length;){if(loops[d].name==b)return d;d++}}function loopPlay(b){loops[loopGet(b)].play()}function loopPause(b){loops[loopGet(b)].pause()}function loopIsPlaying(b){return!0==loops[loopGet(b)].paused?!1:!0}
function loopLoaded(b){return 4==loops[loopGet(b)].readyState?!0:!1}function debugToggle(){debugShow=!1==debugShow?!0:!1}function debugPrint(b){debugLines[debugLines.length]=b}function debugClear(){debugLines.splice(0,debugLines.length)}
function engineStart(){document.getElementById(canvasId).addEventListener("mousedown",mouseClick,!1);document.body.addEventListener("mouseup",mouseRelease,!1);document.body.addEventListener("touchcancel",function(b){b.preventDefault();touchEnd(b)},!1);document.body.addEventListener("touchmove",function(b){b.preventDefault()},!1);document.getElementById(canvasId).addEventListener("touchstart",function(b){b.preventDefault();touchStart(b)},!1);document.getElementById(canvasId).addEventListener("touchmove",
function(b){b.preventDefault();touchMove(b)},!0);document.getElementById(canvasId).addEventListener("touchend",function(b){b.preventDefault();touchEnd(b)},!1);sprites=[];objects=[];instances=[];keys=[];backgrounds=[];sounds=[];loops=[];particleTypes=[];particles=[];debugLines=[];c=document.getElementById(canvasId);cxt=c.getContext("2d");backgroundImage=backgroundColor="none";gamespeed=1E3/60;sts=0;fps=Math.round(1E3/gamespeed);debugShow=debug=!1;debugPlaying=debugText=!0;cameraY=cameraX=0;cameraAngle=
previousCameraAngle=90;mouseStatus=mouseY=mouseX=trueMouseY=trueMouseX=0;keyLastReleased=keyLastPressed=-1;touches=[];stepInterval=setInterval("engineStep()",gamespeed);fpsInterval=setInterval("setFPS()",1E3);eventStart()}
function engineStep(){sts++;2==mouseStatus&&0<touches.length&&(trueMouseX=touches[0].pageX+document.body.scrollLeft+document.documentElement.scrollLeft-c.offsetLeft,trueMouseY=touches[0].pageY+document.body.scrollTop+document.documentElement.scrollTop-c.offsetTop,mouseX=(trueMouseX+cameraX)/xscale,mouseY=(trueMouseY+cameraY)/yscale);for(var b=0;b<instances.length;){if(!0==instances[b].active&&(objectEventStep(b),0<=b&&b<instances.length&&(0!=instances[b].hspeed||0!=instances[b].vspeed)))if(instances[b].x+=
instances[b].hspeed,instances[b].y+=instances[b].vspeed,0<instances[b].friction){var d=pointDistance(0,0,instances[b].hspeed,instances[b].vspeed),e=pointDirection(0,0,instances[b].hspeed,instances[b].vspeed),d=d-instances[b].friction;0>d&&(d=0);instances[b].hspeed=lengthDirX(d,e);instances[b].vspeed=lengthDirY(d,e)}instances.length&&b++}for(b=0;b<particles.length;){particleEventDraw(b);if(0!=particles[b].hspeed||0!=particles[b].vspeed)particles[b].x+=particles[b].hspeed,particles[b].y+=particles[b].vspeed;
0>=particles[b].life?particleDestroy(b):particles[b].life--;b++}eventStep();engineDraw();mouseUpdate();keyUpdate()}
function engineDraw(){cxt.translate(c.width/2,c.height/2);cxt.rotate(-((previousCameraAngle-90)/(180/Math.PI)));cxt.translate(-c.width/2,-c.height/2);cxt.globalAlpha=1;"none"==backgroundColor?cxt.clearRect(0,0,c.width,c.height):(cxt.fillStyle=backgroundColor,cxt.fillRect(0,0,c.width,c.height));if("none"!=backgroundImage){var b=backgroundGet(backgroundImage);if(0==backgrounds[b].tile)cxt.drawImage(backgrounds[b],cameraX,cameraY,backgrounds[b].width,backgrounds[b].height);else if(1==backgrounds[b].tile){for(var d=
Math.min(-cameraX,cameraX);d<-backgrounds[b].width;)d+=backgrounds[b].width;for(;d<c.width;)cxt.drawImage(backgrounds[b],d,cameraY,backgrounds[b].width,backgrounds[b].height),d+=backgrounds[b].width}else if(2==backgrounds[b].tile){for(var e=Math.min(-cameraY,cameraY);e<-backgrounds[b].height;)e+=backgrounds[b].height;for(;e<c.height;)cxt.drawImage(backgrounds[b],cameraY,e,backgrounds[b].width,backgrounds[b].height),e+=backgrounds[b].height}else if(3==backgrounds[b].tile){for(d=Math.min(-cameraX,cameraX);d<
-backgrounds[b].width;)d+=backgrounds[b].width;for(e=Math.min(-cameraY,cameraY);e<-backgrounds[b].height;)e+=backgrounds[b].height;for(;e<c.height;)cxt.drawImage(backgrounds[b],d,e,backgrounds[b].width,backgrounds[b].height),d+=backgrounds[b].width,d>c.width&&(d=Math.min(-cameraX,cameraX),e+=backgrounds[b].height)}}cxt.translate(c.width/2,c.height/2);cxt.rotate((cameraAngle-90)/(180/Math.PI));cxt.translate(-c.width/2,-c.height/2);previousCameraAngle=cameraAngle;b=0;for(d=instances.length;b<d;b++)instances[b].id=
b;for(var e=instances.sort(sortDepth),f=0,g=e.length;f<g;){b=e[f].id;if(b<instances.length&&(!0==instances[b].active&&!getLandscape())&&(objectEventDraw(b),"undefined"!==typeof instances[b]&&(0!=instances[b].alpha&&"none"!=instances[b].sprite)&&(spriteDrawExt(instances[b].sprite,Math.round(instances[b].x),Math.round(instances[b].y),Math.floor(instances[b].imageFrame),instances[b].xoffset,instances[b].yoffset,instances[b].xscale,instances[b].yscale,instances[b].imageAngle,instances[b].alpha),instances[b].imageFrame+=
instances[b].imageSpeed,instances[b].imageFrame>=spriteGet(instances[b].sprite).frames&&(instances[b].imageFrame=0)),!0==debugShow)){var h=cxt.globalAlpha,i=cxt.strokeStyle,d=cxt.lineWidth;cxt.globalAlpha=1;cxt.lineWidth=1;cxt.strokeStyle="lime";var j=Math.round(instances[b].x)+0.5,l=Math.round(instances[b].y)+0.5;cxt.strokeRect(j-3-cameraX,l-3-cameraY,6,6);cxt.strokeStyle="red";var m=Math.round(instances[b].width),n=Math.round(instances[b].height);cxt.strokeRect(j+Math.round(instances[b].maskX-instances[b].xoffset)-
cameraX,l+Math.round(instances[b].maskY-instances[b].yoffset)-cameraY,m,n);cxt.globalAlpha=h;cxt.strokeStyle=i;cxt.lineWidth=d}f++}for(b=0;b<particles.length;b++)particleEventDraw(b);eventDraw();debugDraw()}
function debugDraw(){if(!0==debugShow){cxt.save();cxt.translate(c.width/2,c.height/2);cxt.rotate(-((cameraAngle-90)/(180/Math.PI)));cxt.translate(-c.width/2,-c.height/2);var b=cxt.globalAlpha,d=cxt.fillStyle,e=cxt.strokeStyle,f=cxt.lineWidth;cxt.globalAlpha=0.5;cxt.fillStyle="black";cxt.fillRect(0,0,c.width,c.height);cxt.fillStyle="white";cxt.font="bold 14px Lucida Console";cxt.textBaseline="top";cxt.textAlign="left";cxt.fillText("CanvasLord v"+CLVERSION,8,8);cxt.lineWidth=1;cxt.globalAlpha=!0==pointInRect(8,
22,24,38,trueMouseX,trueMouseY)?1:0.5;cxt.strokeStyle="white";cxt.strokeRect(8.5,22.5,16,16);cxt.beginPath();for(g=26.5;36.5>g;g+=2)cxt.moveTo(12.5,g),cxt.lineTo(20.5,g);cxt.stroke();cxt.closePath();!0==debugText?(cxt.beginPath(),cxt.moveTo(10.5,24.5),cxt.lineTo(22.5,36.5),cxt.moveTo(22.5,24.5),cxt.lineTo(10.5,36.5),cxt.stroke(),cxt.closePath(),2==mouseStatus&&1==cxt.globalAlpha&&(debugText=!1,mouseStatus=1)):2==mouseStatus&&1==cxt.globalAlpha&&(debugText=!0,mouseStatus=1);cxt.globalAlpha=!0==pointInRect(28,
22,44,38,trueMouseX,trueMouseY)?1:0.5;cxt.strokeRect(28.5,22.5,16,16);!1==debugPlaying?(cxt.beginPath(),cxt.moveTo(32.5,24.5),cxt.lineTo(40.5,30.5),cxt.lineTo(32.5,36.5),cxt.closePath(),cxt.fill(),2==mouseStatus&&1==cxt.globalAlpha&&(clearInterval(stepInterval),stepInterval=setInterval("engineStep()",gamespeed),debugPlaying=!0,mouseStatus=1)):(cxt.fillRect(32.5,26.5,3,8),cxt.fillRect(37.5,26.5,3,8),2==mouseStatus&&1==cxt.globalAlpha&&(clearInterval(stepInterval),stepInterval=setInterval("engineDraw()",
gamespeed),debugPlaying=!1,mouseStatus=1));cxt.globalAlpha=!0==pointInRect(48,22,64,38,trueMouseX,trueMouseY)?1:0.5;cxt.strokeRect(48.5,22.5,16,16);cxt.beginPath();cxt.moveTo(52.5,24.5);cxt.lineTo(60.5,30.5);cxt.lineTo(52.5,36.5);cxt.lineTo(54.5,30.5);cxt.closePath();cxt.fill();2==mouseStatus&&1==cxt.globalAlpha&&(setTimeout("engineStep()",1),mouseStatus=1);cxt.globalAlpha=0.5;cxt.textAlign="right";cxt.fillText("FPS: "+fps+" / "+Math.round(1E3/gamespeed),c.width-8,8);cxt.fillText("Instances: "+instances.length,
c.width-8,20);cxt.textAlign="left";if(!0==debugText)for(var g=c.height-20,h=debugLines.length-1;0<=h&&36<=g;)cxt.fillText(debugLines[h],8,g),g-=12,h--;else cxt.fillText("mouse("+mouseX+","+mouseY+")",8,c.height-44),cxt.fillText("trueMouse("+trueMouseX+","+trueMouseY+")",8,c.height-32),cxt.fillText("camera("+cameraX+","+cameraY+","+cameraAngle+")",8,c.height-20);cxt.globalAlpha=b;cxt.fillStyle=d;cxt.strokeStyle=e;cxt.lineWidth=f;cxt.restore()}};